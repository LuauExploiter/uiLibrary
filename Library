

local UI = {}

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
local guiParent = localPlayer:WaitForChild("PlayerGui")

UI.Theme = {
    Background = Color3.fromRGB(22,22,26),
    Panel = Color3.fromRGB(28,28,32),
    Accent = Color3.fromRGB(102,187,255),
    Accent2 = Color3.fromRGB(167,139,250),
    Text = Color3.fromRGB(235,235,240),
    Stroke = Color3.fromRGB(40,40,45),
    Rainbow = false
}

local function new(instanceType, props)
    local inst = Instance.new(instanceType)
    if props then
        for k,v in pairs(props) do inst[k] = v end
    end
    return inst
end

local function tween(obj, props, dur, style, dir)
    TweenService:Create(obj, TweenInfo.new(dur or 0.22, style or Enum.EasingStyle.Quad, dir or Enum.EasingDirection.Out), props):Play()
end

local function addCorner(parent, radius)
    local c = new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 8)
    c.Parent = parent
    return c
end

local function addStroke(parent, color, thickness)
    local s = new("UIStroke")
    s.Color = color or UI.Theme.Stroke
    s.Thickness = thickness or 1
    s.Parent = parent
    return s
end

local function makeGradient(parent, col1, col2, rotation)
    local g = new("UIGradient")
    g.Color = ColorSequence.new({ColorSequenceKeypoint.new(0,col1), ColorSequenceKeypoint.new(1,col2)})
    g.Rotation = rotation or 45
    g.Parent = parent
    return g
end

local function makeSmoothDraggable(frame, handle)
    handle.Active = true
    local dragging = false
    local dragInput, startPos, startMouse
    local targetPos = frame.Position
    local tweening = nil

    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            startMouse = input.Position
            startPos = frame.Position
            if tweening then
                
                tweening:Cancel()
                tweening = nil
            end
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    
                    tweening = TweenService:Create(frame, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = targetPos})
                    tweening:Play()
                end
            end)
        end
    end

    local function onInputChanged(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - startMouse
            local newPos = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
            targetPos = newPos
            frame.Position = newPos 
        end
    end

    handle.InputBegan:Connect(onInputBegan)
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
            onInputChanged(input)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput then onInputChanged(input) end
    end)
end

function UI:Window(title, size, position)
    local screen = new("ScreenGui")
    screen.Name = "UI_Library_ScreenGui"
    screen.ResetOnSpawn = false
    screen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screen.Parent = guiParent

    local root = new("Frame")
    root.Size = size or UDim2.new(0,420,0,320)
    root.Position = position or UDim2.new(0,20,0,20)
    root.BackgroundColor3 = UI.Theme.Background
    root.BorderSizePixel = 0
    root.Parent = screen
    addCorner(root, 14)
    addStroke(root, UI.Theme.Stroke, 1)

    
    local shadow = new("Frame")
    shadow.Size = root.Size + UDim2.new(0,10,0,10)
    shadow.Position = root.Position - UDim2.new(0,5,0,5)
    shadow.BackgroundColor3 = Color3.fromRGB(0,0,0)
    shadow.BackgroundTransparency = 0.75
    shadow.BorderSizePixel = 0
    shadow.ZIndex = 0
    shadow.Parent = screen
    addCorner(shadow, 16)

    
    local titleBar = new("Frame")
    titleBar.Size = UDim2.new(1,0,0,34)
    titleBar.Position = UDim2.new(0,0,0,0)
    titleBar.BackgroundColor3 = UI.Theme.Panel
    titleBar.BorderSizePixel = 0
    titleBar.ZIndex = 2
    titleBar.Parent = root
    addCorner(titleBar, 14)

    local titleLbl = new("TextLabel")
    titleLbl.Size = UDim2.new(1,-120,1,0)
    titleLbl.Position = UDim2.new(0,12,0,0)
    titleLbl.BackgroundTransparency = 1
    titleLbl.Text = title or "Window"
    titleLbl.Font = Enum.Font.GothamSemibold
    titleLbl.TextSize = 16
    titleLbl.TextColor3 = UI.Theme.Text
    titleLbl.TextXAlignment = Enum.TextXAlignment.Left
    titleLbl.Parent = titleBar

    local btnContainer = new("Frame")
    btnContainer.Size = UDim2.new(0,96,1,0)
    btnContainer.AnchorPoint = Vector2.new(1,0)
    btnContainer.Position = UDim2.new(1,-12,0,0)
    btnContainer.BackgroundTransparency = 1
    btnContainer.Parent = titleBar

    local minimizeBtn = new("TextButton")
    minimizeBtn.Size = UDim2.new(0,36,0,24)
    minimizeBtn.Position = UDim2.new(1,-82,0,6)
    minimizeBtn.AnchorPoint = Vector2.new(0,0)
    minimizeBtn.Text = "—"
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.TextSize = 18
    minimizeBtn.TextColor3 = UI.Theme.Text
    minimizeBtn.BackgroundColor3 = UI.Theme.Accent
    minimizeBtn.Parent = titleBar
    addCorner(minimizeBtn, 8)

    local closeBtn = new("TextButton")
    closeBtn.Size = UDim2.new(0,36,0,24)
    closeBtn.Position = UDim2.new(1,-42,0,6)
    closeBtn.AnchorPoint = Vector2.new(0,0)
    closeBtn.Text = "✕"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 16
    closeBtn.TextColor3 = UI.Theme.Text
    closeBtn.BackgroundColor3 = UI.Theme.Accent2
    closeBtn.Parent = titleBar
    addCorner(closeBtn, 8)

    
    local accent = new("Frame")
    accent.Size = UDim2.new(1,0,0,4)
    accent.Position = UDim2.new(0,0,0,34)
    accent.BackgroundColor3 = UI.Theme.Accent
    accent.BorderSizePixel = 0
    accent.Parent = root
    addCorner(accent, 4)
    makeGradient(accent, UI.Theme.Accent, UI.Theme.Accent2, 0)

    
    local tabsBar = new("Frame")
    tabsBar.Size = UDim2.new(1,0,0,36)
    tabsBar.Position = UDim2.new(0,0,0,44)
    tabsBar.BackgroundTransparency = 1
    tabsBar.Parent = root

    local contentArea = new("Frame")
    contentArea.Size = UDim2.new(1,-20,1,-110)
    contentArea.Position = UDim2.new(0,10,0,84)
    contentArea.BackgroundTransparency = 1
    contentArea.Parent = root

    local tabs = {}
    local tabButtons = {}

    
    local function styleButton(btn)
        btn.AutoButtonColor = false
        btn.MouseEnter:Connect(function()
            tween(btn, {BackgroundColor3 = UI.Theme.Hover}, 0.15)
        end)
        btn.MouseLeave:Connect(function()
            tween(btn, {BackgroundColor3 = UI.Theme.Accent}, 0.15)
        end)
        
        btn.MouseButton1Down:Connect(function()
            tween(btn, {Size = btn.Size - UDim2.new(0,6,0,0)}, 0.06)
        end)
        btn.MouseButton1Up:Connect(function()
            tween(btn, {Size = UDim2.new(1, -10, 0, 36)}, 0.08)
        end)
    end

    
    function root:Tab(name)
        
        local idx = #tabButtons + 1
        local tabBtn = new("TextButton")
        tabBtn.Name = "Tab_" .. tostring(idx)
        tabBtn.Size = UDim2.new(0, 110, 0, 30)
        tabBtn.Position = UDim2.new(0, (idx-1) * 112, 0, 2)
        tabBtn.Text = name
        tabBtn.Font = Enum.Font.GothamSemibold
        tabBtn.TextSize = 14
        tabBtn.TextColor3 = UI.Theme.Text
        tabBtn.BackgroundColor3 = UI.Theme.Accent
        tabBtn.BorderSizePixel = 0
        tabBtn.Parent = tabsBar
        addCorner(tabBtn, 8)
        styleButton(tabBtn)
        table.insert(tabButtons, tabBtn)

        
        local tabContent = new("Frame")
        tabContent.Name = "TabContent_" .. tostring(idx)
        tabContent.Size = UDim2.new(1,0,1,0)
        tabContent.Position = UDim2.new(0,0,0,0)
        tabContent.BackgroundTransparency = 1
        tabContent.Visible = false
        tabContent.Parent = contentArea

        
        local layout = new("UIListLayout")
        layout.Padding = UDim.new(0,10)
        layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        layout.Parent = tabContent

        local pad = new("UIPadding")
        pad.PaddingTop = UDim.new(0,6)
        pad.PaddingLeft = UDim.new(0,6)
        pad.Parent = tabContent

        table.insert(tabs, tabContent)

        tabBtn.MouseButton1Click:Connect(function()
            for _,t in ipairs(tabs) do t.Visible = false end
            tabContent.Visible = true
        end)

        
        if #tabs == 1 then
            tabContent.Visible = true
            
            tween(tabBtn, {BackgroundColor3 = UI.Theme.Accent2}, 0.12)
        end

        
        local tabAPI = {}

        function tabAPI:Label(text)
            local lbl = new("TextLabel")
            lbl.Size = UDim2.new(1, -20, 0, 22)
            lbl.BackgroundTransparency = 1
            lbl.Text = text or ""
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 14
            lbl.TextColor3 = UI.Theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = tabContent
            return lbl
        end

        function tabAPI:Button(text, callback)
            local btn = new("TextButton")
            btn.Size = UDim2.new(1, -10, 0, 36)
            btn.BackgroundColor3 = UI.Theme.Accent
            btn.Text = text or "Button"
            btn.Font = Enum.Font.GothamSemibold
            btn.TextSize = 14
            btn.TextColor3 = UI.Theme.Text
            btn.Parent = tabContent
            addCorner(btn, 8)
            styleButton(btn)
            if callback then btn.MouseButton1Click:Connect(function() pcall(callback) end) end
            return btn
        end

        function tabAPI:Toggle(text, default, callback)
            local wrap = new("Frame")
            wrap.Size = UDim2.new(1, -10, 0, 36)
            wrap.BackgroundTransparency = 1
            wrap.Parent = tabContent

            local lbl = new("TextLabel")
            lbl.Size = UDim2.new(0.7, 0, 1, 0)
            lbl.Position = UDim2.new(0, 8, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text or "Toggle"
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 14
            lbl.TextColor3 = UI.Theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = wrap

            local toggleBtn = new("TextButton")
            toggleBtn.Size = UDim2.new(0, 60, 0, 24)
            toggleBtn.Position = UDim2.new(1, -70, 0, 6)
            toggleBtn.BackgroundColor3 = default and UI.Theme.Accent2 or UI.Theme.Panel
            toggleBtn.Text = default and "ON" or "OFF"
            toggleBtn.Font = Enum.Font.GothamBold
            toggleBtn.TextSize = 12
            toggleBtn.TextColor3 = UI.Theme.Text
            toggleBtn.Parent = wrap
            addCorner(toggleBtn, 10)
            toggleBtn.AutoButtonColor = false

            toggleBtn.MouseEnter:Connect(function() tween(toggleBtn, {BackgroundColor3 = UI.Theme.Hover}, 0.12) end)
            toggleBtn.MouseLeave:Connect(function() tween(toggleBtn, {BackgroundColor3 = (default and UI.Theme.Accent2 or UI.Theme.Panel)}, 0.12) end)

            local state = default and true or false
            toggleBtn.MouseButton1Click:Connect(function()
                state = not state
                toggleBtn.Text = state and "ON" or "OFF"
                tween(toggleBtn, {BackgroundColor3 = state and UI.Theme.Accent2 or UI.Theme.Panel}, 0.14)
                if callback then pcall(callback, state) end
            end)

            return wrap
        end

        function tabAPI:Slider(text, min, max, default, callback)
            local wrap = new("Frame")
            wrap.Size = UDim2.new(1, -10, 0, 56)
            wrap.BackgroundTransparency = 1
            wrap.Parent = tabContent

            local lbl = new("TextLabel")
            lbl.Size = UDim2.new(1, 0, 0, 20)
            lbl.Position = UDim2.new(0, 8, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.Text = (text or "Slider").." : "..tostring(default)
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 14
            lbl.TextColor3 = UI.Theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = wrap

            local barBg = new("Frame")
            barBg.Size = UDim2.new(1, -20, 0, 12)
            barBg.Position = UDim2.new(0, 10, 0, 32)
            barBg.BackgroundColor3 = UI.Theme.Panel
            barBg.BorderSizePixel = 0
            barBg.Parent = wrap
            addCorner(barBg, 8)

            local fill = new("Frame")
            fill.Size = UDim2.new(((default - min)/(max - min)), 0, 1, 0)
            fill.BackgroundColor3 = UI.Theme.Accent
            fill.Parent = barBg
            addCorner(fill, 8)

            local dragging = false
            barBg.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local absPos = barBg.AbsolutePosition.X
                    local relativeX = math.clamp(input.Position.X - absPos, 0, barBg.AbsoluteSize.X)
                    local frac = relativeX / barBg.AbsoluteSize.X
                    fill.Size = UDim2.new(frac, 0, 1, 0)
                    local val = min + ((max - min) * frac)
                    lbl.Text = (text or "Slider").." : "..math.floor(val)
                    if callback then pcall(callback, val) end
                end
            end)
            return wrap
        end

        function tabAPI:Dropdown(text, options, callback)
            local wrap = new("Frame")
            wrap.Size = UDim2.new(1, -10, 0, 36)
            wrap.BackgroundTransparency = 1
            wrap.Parent = tabContent

            local lbl = new("TextLabel")
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 8, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text or "Dropdown"
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 14
            lbl.TextColor3 = UI.Theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = wrap

            local btn = new("TextButton")
            btn.Size = UDim2.new(0.34, 0, 0.72, 0)
            btn.Position = UDim2.new(1, -((0.34 * wrap.AbsoluteSize.X) + 12), 0, 6)
            btn.AnchorPoint = Vector2.new(1,0)
            btn.BackgroundColor3 = UI.Theme.Accent
            btn.Text = "Select"
            btn.Font = Enum.Font.GothamSemibold
            btn.TextSize = 13
            btn.TextColor3 = UI.Theme.Text
            btn.Parent = wrap
            addCorner(btn, 8)

            local list = new("Frame")
            list.Size = UDim2.new(1, 0, 0, #options * 30)
            list.Position = UDim2.new(0, 0, 1, 6)
            list.BackgroundColor3 = UI.Theme.Panel
            list.BorderSizePixel = 0
            list.Visible = false
            list.Parent = wrap
            addCorner(list, 8)

            for i,opt in ipairs(options) do
                local item = new("TextButton")
                item.Size = UDim2.new(1, -12, 0, 28)
                item.Position = UDim2.new(0, 8, 0, (i-1)*30 + 4)
                item.BackgroundColor3 = UI.Theme.Panel
                item.Text = opt
                item.Font = Enum.Font.Gotham
                item.TextSize = 13
                item.TextColor3 = UI.Theme.Text
                item.Parent = list
                addCorner(item, 6)
                item.MouseEnter:Connect(function() tween(item, {BackgroundColor3 = UI.Theme.Hover}, 0.12) end)
                item.MouseLeave:Connect(function() tween(item, {BackgroundColor3 = UI.Theme.Panel}, 0.12) end)
                item.MouseButton1Click:Connect(function()
                    btn.Text = opt
                    list.Visible = false
                    if callback then pcall(callback, opt) end
                end)
            end

            btn.MouseButton1Click:Connect(function()
                list.Visible = not list.Visible
            end)

            return wrap
        end

        function tabAPI:MultiSelect(text, options, callback)
            local wrap = new("Frame")
            wrap.Size = UDim2.new(1, -10, 0, 36)
            wrap.BackgroundTransparency = 1
            wrap.Parent = tabContent

            local lbl = new("TextLabel")
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 8, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text or "MultiSelect"
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 14
            lbl.TextColor3 = UI.Theme.Text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = wrap

            local btn = new("TextButton")
            btn.Size = UDim2.new(0.34, 0, 0.72, 0)
            btn.Position = UDim2.new(1, -12, 0, 6)
            btn.AnchorPoint = Vector2.new(1,0)
            btn.BackgroundColor3 = UI.Theme.Accent
            btn.Text = "Select"
            btn.Font = Enum.Font.GothamSemibold
            btn.TextSize = 13
            btn.TextColor3 = UI.Theme.Text
            btn.Parent = wrap
            addCorner(btn, 8)

            local list = new("Frame")
            list.Size = UDim2.new(1, 0, 0, #options * 30)
            list.Position = UDim2.new(0, 0, 1, 6)
            list.BackgroundColor3 = UI.Theme.Panel
            list.BorderSizePixel = 0
            list.Visible = false
            list.Parent = wrap
            addCorner(list, 8)

            local selected = {}

            for i,opt in ipairs(options) do
                local item = new("TextButton")
                item.Size = UDim2.new(1, -12, 0, 28)
                item.Position = UDim2.new(0, 8, 0, (i-1)*30 + 4)
                item.BackgroundColor3 = UI.Theme.Panel
                item.Text = opt
                item.Font = Enum.Font.Gotham
                item.TextSize = 13
                item.TextColor3 = UI.Theme.Text
                item.Parent = list
                addCorner(item, 6)

                item.MouseEnter:Connect(function() tween(item, {BackgroundColor3 = UI.Theme.Hover}, 0.12) end)
                item.MouseLeave:Connect(function() tween(item, {BackgroundColor3 = UI.Theme.Panel}, 0.12) end)
                item.MouseButton1Click:Connect(function()
                    if table.find(selected, opt) then
                        for ii,v in ipairs(selected) do
                            if v == opt then table.remove(selected, ii); break end
                        end
                        item.Text = opt
                    else
                        table.insert(selected, opt)
                        item.Text = opt .. " ✓"
                    end
                    if callback then pcall(callback, selected) end
                end)
            end

            btn.MouseButton1Click:Connect(function()
                list.Visible = not list.Visible
            end)

            return wrap
        end

        function tabAPI:TextBox(placeholder, callback)
            local wrap = new("Frame")
            wrap.Size = UDim2.new(1, -10, 0, 36)
            wrap.BackgroundTransparency = 1
            wrap.Parent = tabContent

            local box = new("TextBox")
            box.Size = UDim2.new(1, -16, 1, 0)
            box.Position = UDim2.new(0,8,0,0)
            box.BackgroundColor3 = UI.Theme.Panel
            box.Text = ""
            box.PlaceholderText = placeholder or ""
            box.Font = Enum.Font.Gotham
            box.TextSize = 14
            box.TextColor3 = UI.Theme.Text
            box.Parent = wrap
            addCorner(box, 8)

            box.FocusLost:Connect(function(enter)
                if enter and callback then pcall(callback, box.Text) end
            end)

            return wrap
        end

        return tabAPI
    end

    
    closeBtn.MouseButton1Click:Connect(function()
        tween(root, {BackgroundTransparency = 1}, 0.18)
        task.delay(0.18, function() screen:Destroy() end)
    end)
    minimizeBtn.MouseButton1Click:Connect(function()
        if root.Size.Y.Offset > 48 then
            tween(root, {Size = UDim2.new(root.Size.X.Scale, root.Size.X.Offset, 0, 52)}, 0.18)
        else
            tween(root, {Size = size or UDim2.new(0,420,0,320)}, 0.18)
        end
    end)

    makeSmoothDraggable(root, titleLbl)

    
    if UI.Theme.Rainbow then
        spawn(function()
            local h = 0
            while screen.Parent do
                h = (h + 0.005) % 1
                local c = Color3.fromHSV(h, 0.85, 1)
                accent.BackgroundColor3 = c
                for _,b in ipairs(tabButtons) do pcall(function() b.BackgroundColor3 = c end) end
                RunService.RenderStepped:Wait()
            end
        end)
    end

    
    return root
end

return UI

